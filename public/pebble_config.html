<!DOCTYPE html>
<html>
  <head>
    <title>Block Breaker Configuration</title>
  </head>
  <body>
    <h1>Block Breaker Configuration</h1>
    <p>Choose watchapp settings</p>
 
    <p>
      Leaderboard Name:
      <input type="text" name="name" id="name_textbox" maxlength="20" minLength="4" pattern="[A-Za-z0-9 ]+" placeholder="Name">
    </p>
 
    <p>
      <button id="save_button">Save</button>
    </p>

    <p>
      <label id="response_label"></label>
    </p>


    <script>
      //Setup to allow easy adding more options later
      function queryStringToJSON() {            
        var pairs = location.search.slice(1).split('&');
        
        var result = {};
        pairs.forEach(function(pair) {
          pair = pair.split('=');
          result[pair[0]] = decodeURIComponent(pair[1] || '');
        });

        return JSON.parse(JSON.stringify(result));
      }

      function isStringBlank(str){
        return str === undefined || str === null || str.match(/^\s*$/) !== null;
      }

      var submitButton = document.getElementById("save_button");
      submitButton.addEventListener("click", function() {
        console.log("Submit");

        var nameTextbox = document.getElementById("name_textbox");
        var name = nameTextbox.value.trim();
        
        var xmlhttp;
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
          xmlhttp = new XMLHttpRequest();
        } else {// code for IE6, IE5
          xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        var queryJSON = queryStringToJSON();
        queryJSON.name = name;

        xmlhttp.open("GET",
                     "/set_name?id=" + queryJSON.id + "&name=" + queryJSON.name + "&account_token=" + queryJSON.account_token, 
                     false);
        xmlhttp.send();

        var responseStatusString = "Error";
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
          var responseJSON = JSON.parse(xmlhttp.responseText);
          if (!isStringBlank(responseJSON.id)) {
            responseStatusString = "Success";
            var location = "pebblejs://close#" + encodeURIComponent(JSON.stringify(responseJSON));
            document.location = location;
          } else if (!isStringBlank(responseJSON.error)) {
            responseStatusString = responseJSON.error;
          }
        }
        console.log(responseStatusString);
        document.getElementById("response_label").value = responseStatusString;
      }, false);
    </script>
  </body>
</html>
